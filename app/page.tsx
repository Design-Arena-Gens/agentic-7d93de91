"use client";

import { useMemo, useState } from 'react';
import MermaidChart from "../components/MermaidChart";
import { generateAllDiagrams, exampleSpec } from "../lib/generator";

export default function Page() {
  const [specText, setSpecText] = useState(JSON.stringify(exampleSpec, null, 2));
  const [error, setError] = useState<string | null>(null);

  const diagrams = useMemo(() => {
    try {
      setError(null);
      const parsed = JSON.parse(specText);
      return generateAllDiagrams(parsed);
    } catch (e: any) {
      setError(e?.message || String(e));
      return [];
    }
  }, [specText]);

  return (
    <div className="container">
      <aside className="sidebar">
        <div className="h1">???? 19.701-90: ?????? ??????? ? ???? ?????</div>
        <div className="text-sm" style={{marginBottom: 12}}>
          ???????? ??? ???????? ???????????? ? ??????? JSON. ??? ?????? ??????? ???????????? ??????????? ????-?????. ????? <code className="code">main</code> ? ??????????????? ??????? ???????.
        </div>

        <div className="h2">????????????</div>
        <textarea className="textarea" value={specText} onChange={(e) => setSpecText(e.target.value)} />
        <div className="row" style={{marginTop: 8}}>
          <button className="button" onClick={() => setSpecText(JSON.stringify(exampleSpec, null, 2))}>???????? ??????</button>
          <button className="button secondary" onClick={() => navigator.clipboard.writeText(specText)}>?????????? JSON</button>
        </div>
        {error && (
          <div className="note" style={{marginTop: 8}}>?????? JSON: {error}</div>
        )}

        <div className="h2">??????? (??????)</div>
        <ul className="text-sm">
          <li>? ????????? ????-????? ??? ?????? ??????? (<code>main</code>, <code>create_array</code>, ? ?.?.).</li>
          <li>? <code>main</code> ?????????? ?????? ???????? ?????? ? ?????? ??? ???????????????? ??????? [[...]].</li>
          <li>? ?????? ?????? ???? (TD). ????? ?????? ????? ????? ?????.</li>
          <li>? ????? ????????? ??????? ????????? ? ???? ???? (???????? ??????).</li>
        </ul>
        <div className="text-sm" style={{marginTop: 8}}>
          ?????????????? ????: <code>start</code>, <code>end</code>, <code>process</code>, <code>call</code>, <code>decision</code> (????? <code>yes</code>/<code>no</code>), <code>loop</code>.
        </div>
      </aside>

      <main className="main">
        <div className="grid">
          {diagrams.map(({ title, code }) => (
            <div key={title} className="card">
              <div className="h2" style={{marginBottom: 8}}>{title}</div>
              <MermaidChart chart={code} />
              <details style={{marginTop: 8}}>
                <summary className="text-sm">???????? Mermaid</summary>
                <pre className="code"><code>{code}</code></pre>
              </details>
            </div>
          ))}
        </div>
      </main>
    </div>
  );
}
